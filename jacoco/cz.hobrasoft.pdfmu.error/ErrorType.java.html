<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ErrorType.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PDF Manipulation Utility</a> &gt; <a href="index.source.html" class="el_package">cz.hobrasoft.pdfmu.error</a> &gt; <span class="el_source">ErrorType.java</span></div><h1>ErrorType.java</h1><pre class="source lang-java linenums">/* 
 * Copyright (C) 2016 Hobrasoft s.r.o.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package cz.hobrasoft.pdfmu.error;

import cz.hobrasoft.pdfmu.IntProperties;
import java.io.IOException;
import java.io.InputStream;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashSet;
import java.util.List;
import java.util.MissingResourceException;
import java.util.ResourceBundle;
import java.util.Set;
import java.util.logging.Logger;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.collections4.functors.StringValueTransformer;

/**
 * Contains all the types of errors (failing conditions) that can happen in
 * PDFMU. Every error type has a code and a message template associated. The
 * codes are loaded from the resource {@value #CODES_RESOURCE_NAME} and the
 * messages are loaded from the resource bundle
 * {@value #MESSAGES_RESOURCE_BUNDLE_BASE_NAME}. The keys in both of the
 * resource files must match the strings returned by
 * {@link ErrorType#toString()} (which returns the enum constant name by
 * default).
 *
 * &lt;p&gt;
 * Assertions are in place that ensure that every error type has a code and a
 * message associated, and that the codes are unique. If assertions are disabled
 * and a resource is missing or incompatible, default values are provided.
 *
 * &lt;p&gt;
 * How to add a new error type:
 * &lt;ul&gt;
 * &lt;li&gt;Add an enum constant in {@link ErrorType}
 * &lt;li&gt;Add a corresponding code in &lt;tt&gt;ErrorCodes.properties&lt;/tt&gt;
 * &lt;li&gt;Add a corresponding message in &lt;tt&gt;ErrorMessages.properties&lt;/tt&gt;
 * &lt;/ul&gt;
 *
 * @author &lt;a href=&quot;mailto:filip.bartek@hobrasoft.cz&quot;&gt;Filip Bartek&lt;/a&gt;
 */
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">public enum ErrorType {</span>
<span class="fc" id="L59">    PARSER_UNKNOWN,</span>
<span class="fc" id="L60">    PARSER_UNRECOGNIZED_COMMAND,</span>
<span class="fc" id="L61">    PARSER_UNRECOGNIZED_ARGUMENT,</span>
<span class="fc" id="L62">    PARSER_INVALID_CHOICE,</span>
<span class="fc" id="L63">    PARSER_TOO_FEW_ARGUMENTS,</span>
<span class="fc" id="L64">    INPUT_NOT_VALID_PDF,</span>
<span class="fc" id="L65">    INPUT_NOT_FOUND,</span>
<span class="fc" id="L66">    INPUT_CLOSE,</span>
<span class="fc" id="L67">    OUTPUT_NOT_SPECIFIED,</span>
<span class="fc" id="L68">    OUTPUT_EXISTS_FORCE_NOT_SET,</span>
<span class="fc" id="L69">    OUTPUT_OPEN,</span>
<span class="fc" id="L70">    OUTPUT_STAMPER_OPEN,</span>
<span class="fc" id="L71">    OUTPUT_STAMPER_CLOSE,</span>
<span class="fc" id="L72">    OUTPUT_CLOSE,</span>
<span class="fc" id="L73">    OUTPUT_WRITE,</span>
<span class="fc" id="L74">    SIGNATURE_ADD_KEYSTORE_TYPE_UNSUPPORTED,</span>
<span class="fc" id="L75">    SIGNATURE_ADD_KEYSTORE_FILE_NOT_SPECIFIED,</span>
<span class="fc" id="L76">    SIGNATURE_ADD_KEYSTORE_FILE_OPEN,</span>
<span class="fc" id="L77">    SIGNATURE_ADD_KEYSTORE_LOAD,</span>
<span class="fc" id="L78">    SIGNATURE_ADD_KEYSTORE_FILE_CLOSE,</span>
<span class="fc" id="L79">    SIGNATURE_ADD_KEYSTORE_ALIASES,</span>
<span class="fc" id="L80">    SIGNATURE_ADD_KEYSTORE_EMPTY,</span>
<span class="fc" id="L81">    SIGNATURE_ADD_KEYSTORE_ALIAS_MISSING,</span>
<span class="fc" id="L82">    SIGNATURE_ADD_KEYSTORE_ALIAS_EXCEPTION,</span>
<span class="fc" id="L83">    SIGNATURE_ADD_KEYSTORE_ALIAS_NOT_KEY,</span>
<span class="fc" id="L84">    SIGNATURE_ADD_KEYSTORE_ALIAS_KEY_EXCEPTION,</span>
<span class="fc" id="L85">    SIGNATURE_ADD_KEYSTORE_PRIVATE_KEY,</span>
<span class="fc" id="L86">    SIGNATURE_ADD_KEYSTORE_CERTIFICATE_CHAIN,</span>
<span class="fc" id="L87">    SIGNATURE_ADD_UNSUPPORTED_DIGEST_ALGORITHM,</span>
<span class="fc" id="L88">    SIGNATURE_ADD_FAIL,</span>
<span class="fc" id="L89">    SIGNATURE_ADD_TSA_UNTRUSTED,</span>
<span class="fc" id="L90">    SIGNATURE_ADD_TSA_UNAUTHORIZED,</span>
<span class="fc" id="L91">    SIGNATURE_ADD_TSA_LOGIN_FAIL,</span>
<span class="fc" id="L92">    SIGNATURE_ADD_TSA_UNREACHABLE,</span>
<span class="fc" id="L93">    SIGNATURE_ADD_TSA_BAD_CERTIFICATE,</span>
<span class="fc" id="L94">    SIGNATURE_ADD_TSA_HANDSHAKE_FAILURE,</span>
<span class="fc" id="L95">    SIGNATURE_ADD_TSA_SSL_HANDSHAKE_EXCEPTION,</span>
<span class="fc" id="L96">    SIGNATURE_ADD_TSA_SSL_FATAL_ALERT,</span>
<span class="fc" id="L97">    SIGNATURE_ADD_TSA_INVALID_URL,</span>
<span class="fc" id="L98">    SIGNATURE_ADD_SIGNATURE_EXCEPTION,</span>
<span class="fc" id="L99">    ATTACH_FAIL,</span>
<span class="fc" id="L100">    ATTACH_ATTACHMENT_EQUALS_OUTPUT,</span>
<span class="fc" id="L101">    SSL_TRUSTSTORE_NOT_FOUND,</span>
<span class="fc" id="L102">    SSL_TRUSTSTORE_INCORRECT_TYPE,</span>
<span class="fc" id="L103">    SSL_TRUSTSTORE_EMPTY,</span>
<span class="fc" id="L104">    SSL_KEYSTORE_NOT_FOUND;</span>

    /**
     * The default error code. It is used for error types that have no code
     * associated.
     *
     * &lt;p&gt;
     * Value: {@value #DEFAULT_ERROR_CODE}
     */
    public static final int DEFAULT_ERROR_CODE = -1;

    /**
     * The name of the resource that contains the error codes. The resource must
     * be a properties file. It is located using
     * {@link ClassLoader#getResourceAsStream(String)} and loaded using
     * {@link IntProperties#load(InputStream)}.
     *
     * &lt;p&gt;
     * Value: {@value #CODES_RESOURCE_NAME}
     */
    public static final String CODES_RESOURCE_NAME = &quot;cz/hobrasoft/pdfmu/error/ErrorCodes.properties&quot;;

    /**
     * The base name of the resource bundle that contains the error messages.
     * The resource bundle is loaded using
     * {@link ResourceBundle#getBundle(String)}.
     *
     * &lt;p&gt;
     * Value: {@value #MESSAGES_RESOURCE_BUNDLE_BASE_NAME}
     */
    public static final String MESSAGES_RESOURCE_BUNDLE_BASE_NAME = &quot;cz.hobrasoft.pdfmu.error.ErrorMessages&quot;;

<span class="fc" id="L136">    private static final Logger LOGGER = Logger.getLogger(ErrorType.class.getName());</span>

<span class="fc" id="L138">    private static final IntProperties CODES = new IntProperties(DEFAULT_ERROR_CODE);</span>
<span class="fc" id="L139">    private static ResourceBundle messages = null;</span>

    /**
     * @return true iff each of the constants of this enum is a key in both
     * {@link #CODES} and {@link #messages}.
     */
    private static boolean codesAndMessagesAvailable() {
<span class="fc" id="L146">        ErrorType[] enumKeyArray = ErrorType.values();</span>
<span class="fc" id="L147">        List&lt;ErrorType&gt; enumKeyList = Arrays.asList(enumKeyArray);</span>
<span class="fc" id="L148">        Collection&lt;String&gt; enumKeyStrings = CollectionUtils.collect(enumKeyList, StringValueTransformer.stringValueTransformer());</span>

<span class="fc" id="L150">        Set&lt;String&gt; codeKeySet = CODES.stringPropertyNames();</span>
<span class="pc bpc" id="L151" title="2 of 4 branches missed.">        assert messages != null;</span>
<span class="fc" id="L152">        Set&lt;String&gt; messageKeySet = messages.keySet();</span>

<span class="pc bpc" id="L154" title="2 of 4 branches missed.">        return codeKeySet.containsAll(enumKeyStrings) &amp;&amp; messageKeySet.containsAll(enumKeyStrings);</span>
    }

    /**
     * @return true iff the codes stored in {@link #CODES} are pairwise
     * different.
     */
    private static boolean codesUnique() {
<span class="fc" id="L162">        Collection&lt;Integer&gt; codes = CODES.intPropertyValues();</span>
<span class="fc" id="L163">        Set&lt;Integer&gt; codesUnique = new HashSet&lt;&gt;(codes);</span>
<span class="pc bpc" id="L164" title="2 of 4 branches missed.">        assert codes.size() &gt;= codesUnique.size();</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">        return codes.size() == codesUnique.size();</span>
    }

    /**
     * Loads error codes from the properties resource
     * {@link #CODES_RESOURCE_NAME} and stores them in {@link #CODES}.
     */
    private static void loadErrorCodes() {
<span class="fc" id="L173">        ClassLoader classLoader = ErrorType.class.getClassLoader();</span>
<span class="fc" id="L174">        InputStream in = classLoader.getResourceAsStream(CODES_RESOURCE_NAME);</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (in != null) {</span>
            try {
<span class="fc" id="L177">                CODES.load(in);</span>
<span class="nc" id="L178">            } catch (IOException ex) {</span>
<span class="nc" id="L179">                LOGGER.severe(String.format(&quot;Could not load the error codes properties file: %s&quot;, ex));</span>
<span class="fc" id="L180">            }</span>
            try {
<span class="fc" id="L182">                in.close();</span>
<span class="nc" id="L183">            } catch (IOException ex) {</span>
<span class="nc" id="L184">                LOGGER.severe(String.format(&quot;Could not close the error codes properties file: %s&quot;, ex));</span>
<span class="pc" id="L185">            }</span>
        } else {
<span class="nc" id="L187">            LOGGER.severe(&quot;Could not open the error codes properties file.&quot;);</span>
        }
<span class="fc" id="L189">    }</span>

    /**
     * Loads error messages from the resource bundle
     * {@link #MESSAGES_RESOURCE_BUNDLE_BASE_NAME} and stores them in
     * {@link #messages}.
     */
    private static void loadErrorMessages() {
        try {
<span class="fc" id="L198">            messages = ResourceBundle.getBundle(MESSAGES_RESOURCE_BUNDLE_BASE_NAME);</span>
<span class="nc" id="L199">        } catch (MissingResourceException ex) {</span>
<span class="nc" id="L200">            LOGGER.severe(String.format(&quot;Could not load the error messages resource bundle: %s&quot;, ex));</span>
<span class="fc" id="L201">        }</span>
<span class="fc" id="L202">    }</span>

    static {
        // Load error codes and messages before OperationException is instantiated
<span class="fc" id="L206">        loadErrorCodes();</span>
<span class="fc" id="L207">        loadErrorMessages();</span>
<span class="pc bpc" id="L208" title="2 of 4 branches missed.">        assert messages != null;</span>

        // Assert that a code and a message is available for every enum constant
<span class="pc bpc" id="L211" title="2 of 4 branches missed.">        assert codesAndMessagesAvailable();</span>

        // Assert that the codes are pairwise different
<span class="pc bpc" id="L214" title="2 of 4 branches missed.">        assert codesUnique();</span>
<span class="fc" id="L215">    }</span>

    /**
     * Returns the error code associated with this error type. The code should
     * uniquely identify the error. The value of {@link #DEFAULT_ERROR_CODE} is
     * returned if no code is associated with this error type. The error codes
     * are loaded from the resource {@value #CODES_RESOURCE_NAME} when the first
     * {@link ErrorType} is instantiated.
     *
     * @return the error code associated with this error type, or
     * {@value #DEFAULT_ERROR_CODE} if none is associated
     */
    public int getCode() {
<span class="fc" id="L228">        return CODES.getIntProperty(toString());</span>
    }

    /**
     * Returns the message pattern associated with this error type. The message
     * patterns are loaded from the resource bundle
     * {@value #MESSAGES_RESOURCE_BUNDLE_BASE_NAME} when the first
     * {@link ErrorType} is instantiated.
     *
     * @return the message pattern associated with this error type, or null if
     * none is associated
     */
    public String getMessagePattern() {
<span class="fc" id="L241">        String key = toString();</span>
<span class="pc bpc" id="L242" title="2 of 4 branches missed.">        assert messages != null;</span>
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">        if (messages.containsKey(key)) {</span>
<span class="fc" id="L244">            return messages.getString(key);</span>
        } else {
<span class="nc" id="L246">            return null;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>